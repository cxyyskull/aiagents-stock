# 风险管理师增强功能说明 ⚠️

## 📋 功能概述

风险管理师功能已全面增强，现在使用**问财（pywencai）**实时获取三大类风险数据，为投资决策提供更全面的风险评估。

## ✨ 新增功能

### 1. 三大风险数据源 🔍

风险管理师现在会自动查询以下三类关键风险信息：

| 风险类型 | 查询问句 | 数据内容 |
|---------|---------|---------|
| **限售解禁** | `股票代码限售解禁` | 解禁时间、解禁股数、解禁市值、股东名称 |
| **大股东减持** | `股票代码大股东减持公告` | 减持日期、股东名称、减持股数、减持比例 |
| **重要事件** | `股票代码近期重要事件` | 事件时间、事件类型、事件内容 |

### 2. 完整数据传递 📊

系统会将pywencai返回的**完整原始数据**喂给AI，包括：

- **所有字段**：不遗漏任何信息
- **所有记录**：最多传递50条记录（避免过载）
- **结构化格式**：AI易于解析的格式
- **详细信息**：时间、金额、比例、股东名称等

**数据传递示例：**

```
================================================================================
【限售解禁完整数据】
================================================================================
查询语句: 600000限售解禁

共 10 条限售解禁记录

数据字段：股票代码, 股票简称, 解禁时间, 解禁股数, 解禁市值, 股东名称, ...

【记录 1】
  股票代码: 600000
  股票简称: 浦发银行
  解禁时间: 2024-03-15
  解禁股数: 500000000
  解禁市值: 5000000000
  股东名称: 某某投资公司
  ...

【记录 2】
  ...
```

### 3. 智能风险分析 🧠

风险管理师会**深度解析所有原始数据**，进行**11个维度**的全面风险评估：

#### ⭐ 三大重点风险分析

1. **限售解禁风险分析**
   - 解禁时间和规模评估
   - 解禁对股价的潜在冲击
   - 解禁股东类型分析（创始人/投资机构/其他）
   - 历史解禁后股价走势参考
   - 风险等级评定和应对建议

2. **股东减持风险分析**
   - 减持频率和力度评估
   - 减持股东身份和意图分析
   - 减持对市场信心的影响
   - 是否存在连续减持或集中减持
   - 风险警示和投资建议

3. **重要事件风险分析**
   - 识别可能影响股价的重大事件
   - 事件性质判断（利好/利空/中性）
   - 事件影响的时间维度（短期/中期/长期）
   - 事件的确定性和不确定性
   - 风险提示和关注要点

#### 📊 其他风险维度

4. **市场风险**（系统性风险）
5. **个股风险**（非系统性风险）
6. **流动性风险**
7. **波动性风险**
8. **估值风险**
9. **行业风险**
10. **综合风险评定**
11. **风险控制建议** ⭐

### 4. AI深度解析能力 🤖

AI会对每条原始记录进行深度分析：

- **时间识别**：自动识别日期字段，关注最近和即将发生的事件
- **金额量化**：评估解禁市值、减持金额的规模和影响
- **股东分析**：识别股东类型（创始人/机构/高管）
- **频率统计**：分析减持频率，判断是否连续减持
- **趋势预判**：基于历史数据预测未来风险

### 5. 可操作的风险控制建议 📋

风险管理师会提供具体的风险控制建议：

- **仓位控制建议**：具体的仓位比例建议
- **止损位设置**：具体的止损价位建议
- **风险规避策略**：明确什么情况下不建议投资
- **风险对冲方案**：如果适用，提供对冲策略
- **持仓时间建议**：建议的持仓周期
- **重点关注指标**：需要持续监控的关键指标

## 🎯 使用方法

### 自动获取（推荐）✅

风险管理师默认启用，系统会自动获取风险数据：

1. 在股票分析界面，确保**风险管理师**处于勾选状态
2. 输入股票代码（仅支持**A股6位代码**）
3. 点击"开始分析"
4. 系统自动获取风险数据并进行分析

### 数据获取流程 🔄

```
1. 查询限售解禁数据 → 2秒延迟 
2. 查询大股东减持数据 → 2秒延迟
3. 查询重要事件数据 → 完成
4. 综合所有数据进行AI分析
```

## 📊 数据展示

### 获取成功提示

```
✅ 成功获取风险数据：限售解禁, 大股东减持, 重要事件
```

### 部分数据提示

```
ℹ️ 成功获取风险数据：大股东减持
ℹ️ 暂无限售解禁和重要事件数据
```

### 无数据提示

```
ℹ️ 暂无风险相关数据，将基于基本信息进行风险分析
```

### 美股提示

```
ℹ️ 美股暂不支持风险数据（限售解禁、大股东减持等）
```

## 💡 使用场景

### 场景1：发现解禁风险 🚨

**案例**：某股票即将迎来大规模限售解禁

**风险管理师分析**：
- 识别解禁时间窗口
- 评估解禁规模对股价的压力
- 分析解禁股东类型（创始人vs机构）
- 建议：解禁前减仓，解禁后观察

### 场景2：监控股东减持 ⚠️

**案例**：大股东连续减持

**风险管理师分析**：
- 识别减持频率和强度
- 分析减持股东身份（实际控制人/财务投资者）
- 评估对市场信心的影响
- 建议：降低仓位，设置止损位

### 场景3：追踪重要事件 📰

**案例**：公司面临重大诉讼或政策变动

**风险管理师分析**：
- 识别事件性质和影响范围
- 评估短中长期影响
- 判断事件的不确定性
- 建议：谨慎持仓，关注后续进展

## 🔧 技术实现

### 核心模块

```
risk_data_fetcher.py       # 风险数据获取模块
├── RiskDataFetcher        # 风险数据获取类
│   ├── get_risk_data()    # 主函数：获取所有风险数据
│   ├── _get_lifting_ban_data()        # 获取限售解禁
│   ├── _get_shareholder_reduction_data()  # 获取股东减持
│   ├── _get_important_events_data()   # 获取重要事件
│   ├── format_risk_data_for_ai()      # 格式化供AI分析（完整数据）
│   └── _format_dataframe_for_ai()     # DataFrame转文本格式
```

### 数据处理流程

```
pywencai查询 → DataFrame原始数据 → 格式化为文本 → 喂给AI
    ↓              ↓                    ↓              ↓
  问句查询      保留所有字段        逐行格式化      深度解析
  实时数据      完整记录           AI可读         量化评估
```

### 数据流程

```
用户输入股票代码
    ↓
stock_data.py → get_risk_data()
    ↓
risk_data_fetcher.py → 调用pywencai
    ↓
获取三类风险数据
    ↓
ai_agents.py → risk_management_agent()
    ↓
DeepSeek AI 深度分析
    ↓
生成风险评估报告
```

## 📈 数据来源

- **数据源**：问财（pywencai）
- **更新频率**：实时查询
- **查询语法**：自然语言问句
- **数据类型**：结构化表格数据

## ⚙️ 配置说明

### 默认配置

```python
# 风险管理师默认启用
enable_risk = True

# 仅支持A股
supported_markets = ["中国A股（6位代码）"]

# 查询延迟（避免频繁请求）
query_delay = 1秒
```

### 在批量分析中使用

```python
# 批量分析也支持风险管理功能
enabled_analysts_config = {
    'technical': True,
    'fundamental': True,
    'fund_flow': True,
    'risk': True,      # 启用风险管理师
    'sentiment': False,
    'news': False
}
```

## 🎓 最佳实践

### 1. 结合其他分析师 👥

风险管理师的分析应该与其他分析师综合判断：

- **技术分析师**：识别技术面风险信号
- **基本面分析师**：评估基本面恶化风险
- **资金面分析师**：监控主力资金流出
- **风险管理师**：识别特定风险事件

### 2. 重点关注时间窗口 ⏰

特别关注以下时间窗口的风险：

- 解禁前1个月：提前规避风险
- 减持公告后：评估市场反应
- 重大事件发生时：及时调整策略

### 3. 设置风险预警 🔔

可以结合监测功能，设置风险预警：

- 解禁预警：提前30天预警
- 减持预警：出现减持公告时预警
- 事件预警：重大负面事件预警

## 📝 注意事项

### 支持范围

✅ **支持**：中国A股（6位数字代码）  
❌ **不支持**：美股、港股

### 数据时效性

- 数据来自问财实时查询
- 可能存在1-2个交易日的延迟
- 建议定期刷新分析

### 网络依赖

- 需要稳定的网络连接
- 查询可能需要5-10秒
- 失败时会自动降级到基础分析

### 数据准确性

- 数据来源于公开信息
- 建议交叉验证重要信息
- 以官方公告为准

## 🚀 未来规划

### 计划新增功能

- [ ] 风险评分量化模型
- [ ] 风险历史对比分析
- [ ] 风险预警阈值设置
- [ ] 风险事件影响回测
- [ ] 多股票风险对比分析

### 优化方向

- 增加更多风险数据源
- 优化数据查询速度
- 提升AI分析准确度
- 增强可视化展示

## 📞 问题反馈

如果在使用过程中遇到问题：

1. **数据获取失败**：检查网络连接，稍后重试
2. **分析结果异常**：确认股票代码正确（6位A股代码）
3. **其他问题**：查看控制台错误信息

## 📚 相关文档

- `主力选股使用指南.md` - 了解主力资金分析
- `分析师团队选择功能说明.md` - 了解如何选择分析师
- `智瞰龙虎功能说明.md` - 了解龙虎榜风险分析

## 🎯 总结

风险管理师增强功能通过**问财实时数据**和**完整数据传递**，为投资者提供：

✅ **三大风险数据**：限售解禁、大股东减持、重要事件  
✅ **完整原始数据**：所有字段、所有记录，不遗漏任何信息  
✅ **AI深度解析**：自动识别关键风险点，量化评估  
✅ **11维度分析**：全面评估各类风险  
✅ **可操作建议**：具体的风险控制策略  
✅ **实时更新**：基于最新公开信息  
✅ **智能分析**：DeepSeek AI从海量数据中提取关键信息  

**核心优势：**
- 不再是摘要或概括，而是**完整原始数据**
- AI自主解析每条记录的**每个字段**
- 基于实际数据给出**量化风险评估**
- 让AI的分析更准确、更深入、更可靠

让投资决策更安全、更可靠！⚠️📊💡

